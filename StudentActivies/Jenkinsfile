pipeline {
    agent any

    triggers {
        pollSCM('H/5 * * * *') 
    }

    environment {
        // Hostname của server chạy Docker Registry và nơi deploy app
        // Sử dụng hostname thay vì IP để tránh phải cập nhật khi IP thay đổi
        DEPLOY_SERVER = "${env.DEPLOY_HOSTNAME ?: env.COMPUTERNAME ?: 'localhost'}"
        REGISTRY_URL = "${DEPLOY_SERVER}:5443" 
        IMAGE_NAME   = "studentactivities"
        IMAGE_TAG    = "latest"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Docker Build') {
            steps {
                script {
                    // Debug: Kiểm tra cấu trúc thư mục trên Linux (dùng ls -la thay vì dir)
                    sh 'ls -la'
                    // Lưu ý: Kiểm tra kỹ tên thư mục là "StudentActivies" hay "StudentActivities" trong code của bạn
                    sh 'ls -la StudentActivies' 
                    
                    // Build Docker image (dùng sh)
                    sh """
                        docker build -t ${IMAGE_NAME}:${IMAGE_TAG} -f StudentActivies/Dockerfile .
                    """
                }
            }
        }

        stage('Docker Tag & Push') {
            steps {
                withCredentials([usernamePassword(
                    credentialsId: 'docker-registry',
                    usernameVariable: 'REGISTRY_USER',
                    passwordVariable: 'REGISTRY_PASS'
                )]) {
                    script {
                        // 1. Tag ảnh
                        sh "docker tag ${IMAGE_NAME}:${IMAGE_TAG} ${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG}"

                        // 2. Login vào Registry (Cú pháp Linux: dùng $VAR thay vì %VAR%)
                        sh "echo $REGISTRY_PASS | docker login ${REGISTRY_URL} -u $REGISTRY_USER --password-stdin"

                        // 3. Push ảnh lên
                        sh "docker push ${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG}"
                    }
                }
            }
        }

        stage('Deploy to Server') {
            steps {
                script {
                    // 1. Kích hoạt SSH Agent để có quyền truy cập Server
                    sshagent(['ssh-credentials']) {
                        
                        // 2. Copy env file lên server
                        sh """
                            scp -o StrictHostKeyChecking=no .env.production jenkins@${DEPLOY_SERVER}:C:/Users/jenkins/app.env
                        """
                        
                        // 3. Lấy lại User/Pass Docker để đăng nhập trên Server đích
                        withCredentials([usernamePassword(
                            credentialsId: 'docker-registry',
                            usernameVariable: 'REGISTRY_USER',
                            passwordVariable: 'REGISTRY_PASS'
                        )]) {
                            // 4. Thực hiện lệnh SSH với escape đúng các biến
                            sh """
                                ssh -o StrictHostKeyChecking=no jenkins@${DEPLOY_SERVER} << 'ENDSSH'
                                    echo "Dang nhap Docker..."
                                    echo \${REGISTRY_PASS} | docker login ${REGISTRY_URL} -u \${REGISTRY_USER} --password-stdin
                                    
                                    echo "Pull image..."
                                    docker pull ${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG}
                                    
                                    echo "Restart container..."
                                    docker stop ${IMAGE_NAME} || true
                                    docker rm ${IMAGE_NAME} || true
                                    docker run -d --name ${IMAGE_NAME} -p 80:8080 --restart always \\
                                        --env-file C:/Users/jenkins/app.env \\
                                        ${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG}
                                    
                                    echo "Deployment completed!"
ENDSSH
                            """
                        }
                    }
                }
            }
        }
    }
}