pipeline {
    agent any

    triggers {
        pollSCM('H/5 * * * *') 
    }

    environment {
        // Registry phải dùng IP LAN để các máy khác truy cập được
        REGISTRY_URL = "192.168.102.3:5443" 
        IMAGE_NAME   = "studentactivities"
        IMAGE_TAG    = "latest"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Docker Build') {
            steps {
                script {
                    // Debug: Kiểm tra cấu trúc thư mục trên Linux (dùng ls -la thay vì dir)
                    sh 'ls -la'
                    // Lưu ý: Kiểm tra kỹ tên thư mục là "StudentActivies" hay "StudentActivities" trong code của bạn
                    sh 'ls -la StudentActivies' 
                    
                    // Build Docker image (dùng sh)
                    sh """
                        docker build -t ${IMAGE_NAME}:${IMAGE_TAG} -f StudentActivies/Dockerfile .
                    """
                }
            }
        }

        stage('Docker Tag & Push') {
            steps {
                withCredentials([usernamePassword(
                    credentialsId: 'docker-registry',
                    usernameVariable: 'REGISTRY_USER',
                    passwordVariable: 'REGISTRY_PASS'
                )]) {
                    script {
                        // 1. Tag ảnh
                        sh "docker tag ${IMAGE_NAME}:${IMAGE_TAG} ${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG}"

                        // 2. Login vào Registry (Cú pháp Linux: dùng $VAR thay vì %VAR%)
                        sh "echo $REGISTRY_PASS | docker login ${REGISTRY_URL} -u $REGISTRY_USER --password-stdin"

                        // 3. Push ảnh lên
                        sh "docker push ${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG}"
                    }
                }
            }
        }

        stage('Deploy to Server') {
            steps {
                script {
                    // 1. Kích hoạt SSH Agent để có quyền truy cập Server
                    sshagent(['ssh-credentials']) {
                        
                        // 2. Lấy lại User/Pass Docker để đăng nhập trên Server đích
                        withCredentials([usernamePassword(
                            credentialsId: 'docker-registry',
                            usernameVariable: 'REGISTRY_USER',
                            passwordVariable: 'REGISTRY_PASS'
                        )]) {
                            // 3. Thực hiện lệnh SSH với escape đúng các biến
                            sh """
                                ssh -o StrictHostKeyChecking=no jenkins@192.168.102.3 "
                                    echo 'Dang nhap Docker...'
                                    echo \${REGISTRY_PASS} | docker login ${REGISTRY_URL} -u \${REGISTRY_USER} --password-stdin
                                    
                                    echo 'Pull image...'
                                    docker pull ${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG}
                                    
                                    echo 'Restart container...'
                                    docker stop ${IMAGE_NAME} || true
                                    docker rm ${IMAGE_NAME} || true
                                    docker run -d --name ${IMAGE_NAME} -p 80:8080 --restart always \
                                        -e ASPNETCORE_ENVIRONMENT=Production \
                                        -e ConnectionStrings__DefaultConnection='User Id=postgres.gvhtbrnyoanxfuozrehn;Password=StudentActivities-123456;Server=aws-1-ap-southeast-1.pooler.supabase.com;Port=5432;Database=postgres' \
                                        -e MinIO__Endpoint=minio:9000 \
                                        -e MinIO__AccessKey=miniouser \
                                        -e MinIO__SecretKey=minio123456 \
                                        -e MinIO__BucketName=studentactivities \
                                        -e MinIO__UseSSL=false \
                                        ${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG}
                                    
                                    echo 'Deployment completed!'
                                "
                            """
                        }
                    }
                }
            }
        }
    }
}