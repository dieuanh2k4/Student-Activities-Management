pipeline {
    agent any

    triggers {
        pollSCM('H/5 * * * *') 
    }

    environment {
        // Lưu ý: Nếu Jenkins chạy trong Docker, 'localhost' có thể trỏ vào container Jenkins chứ không phải máy host.
        // Bạn có thể cần dùng IP host hoặc tên service trong Docker network.
        REGISTRY_URL = "localhost:5000" 
        IMAGE_NAME   = "studentactivities"
        IMAGE_TAG    = "latest"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Docker Build') {
            steps {
                script {
                    // Debug: Kiểm tra cấu trúc thư mục trên Linux (dùng ls -la thay vì dir)
                    sh 'ls -la'
                    // Lưu ý: Kiểm tra kỹ tên thư mục là "StudentActivies" hay "StudentActivities" trong code của bạn
                    sh 'ls -la StudentActivies' 
                    
                    // Build Docker image (dùng sh)
                    sh """
                        docker build -t ${IMAGE_NAME}:${IMAGE_TAG} -f StudentActivies/Dockerfile .
                    """
                }
            }
        }

        stage('Docker Tag & Push') {
            steps {
                withCredentials([usernamePassword(
                    credentialsId: 'docker-registry',
                    usernameVariable: 'REGISTRY_USER',
                    passwordVariable: 'REGISTRY_PASS'
                )]) {
                    script {
                        // 1. Tag ảnh
                        sh "docker tag ${IMAGE_NAME}:${IMAGE_TAG} ${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG}"

                        // 2. Login vào Registry (Cú pháp Linux: dùng $VAR thay vì %VAR%)
                        sh "echo $REGISTRY_PASS | docker login ${REGISTRY_URL} -u $REGISTRY_USER --password-stdin"

                        // 3. Push ảnh lên
                        sh "docker push ${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG}"
                    }
                }
            }
        }

        stage('Deploy to Server') {
            steps {
                script {
                    // 1. Kích hoạt SSH Agent để có quyền truy cập Server
                    sshagent(['ssh-credentials-id']) {
                        
                        // 2. Lấy lại User/Pass Docker để đăng nhập trên Server đích
                        withCredentials([usernamePassword(
                            credentialsId: 'docker-registry',
                            usernameVariable: 'REGISTRY_USER',
                            passwordVariable: 'REGISTRY_PASS'
                        )]) {
                            // 3. Thực hiện lệnh SSH
                            sh """
                                ssh -o StrictHostKeyChecking=no user@192.168.x.x "
                                    echo 'Dang nhap Docker...'
                                    echo $REGISTRY_PASS | docker login ${REGISTRY_URL} -u $REGISTRY_USER --password-stdin
                                    
                                    echo 'Pull image...'
                                    docker pull ${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG}
                                    
                                    echo 'Restart container...'
                                    docker stop ${IMAGE_NAME} || true
                                    docker rm ${IMAGE_NAME} || true
                                    docker run -d --name ${IMAGE_NAME} -p 80:8080 --restart always ${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG}
                                "
                            """
                        }
                    }
                }
            }
        }
    }
}